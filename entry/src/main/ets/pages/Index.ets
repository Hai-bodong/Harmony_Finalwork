import router from '@ohos.router';
import { display } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit'; // å¯¼å…¥ hilog ç”¨äºŽè°ƒè¯•

const DOMAIN_INDEX_PAGE = 0x0002; // ä¸º Index.ets å®šä¹‰ä¸€ä¸ªå•ç‹¬çš„DOMAIN

@Entry
@Component
struct Index {
  @State showInitialPrompt: boolean = true; // æŽ§åˆ¶åˆå§‹æç¤ºå¼¹çª—çš„æ˜¾ç¤º
  @State showMessagePopup: boolean = false; // æŽ§åˆ¶æ–°æ¶ˆæ¯å¼¹çª—çš„æ˜¾ç¤º
  @State cardWidth: number = 280;
  @State cardHeight: number = 400;
  @State currentTabIndex: number = 0;
  @State currentBottomTab: number = 0;

  aboutToAppear() {
    hilog.info(DOMAIN_INDEX_PAGE, 'IndexPage', 'Index.ets aboutToAppear called');
    this.calculateCardSize();

    // åˆå§‹æç¤ºå¼¹çª—çš„éšè—é€»è¾‘
    setTimeout(() => {
      this.showInitialPrompt = false;
      hilog.info(DOMAIN_INDEX_PAGE, 'IndexPage', 'Initial prompt hidden.');

      // åœ¨åˆå§‹æç¤ºéšè—åŽï¼Œæ˜¾ç¤ºæ–°æ¶ˆæ¯å¼¹çª—
      this.showMessagePopup = true;
      hilog.info(DOMAIN_INDEX_PAGE, 'IndexPage', 'Message popup shown.');

      // 3ç§’åŽéšè—æ–°æ¶ˆæ¯å¼¹çª—
      setTimeout(() => {
        this.showMessagePopup = false;
        hilog.info(DOMAIN_INDEX_PAGE, 'IndexPage', 'Message popup hidden after 3 seconds.');
      }, 3000); // 3ç§’åŽéšè—
    }, 1000); // 1ç§’åŽéšè—åˆå§‹æç¤º
  }

  calculateCardSize() {
    const displayWidth = display.getDefaultDisplaySync().width;
    const padding = 40;
    const gap = 20;
    let calculatedWidth = (displayWidth - padding - gap * 2) / 3;
    calculatedWidth = Math.max(200, Math.min(calculatedWidth, 320));
    this.cardWidth = calculatedWidth;
    this.cardHeight = calculatedWidth * 1.43;
  }

  build() {
    Stack({ alignContent: Alignment.Top }) {
      // èƒŒæ™¯æ”¹ä¸ºé»‘è‰²
      Column() {
        Blank();
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#121212');

      // Logoé¢œè‰²æ”¹ä¸ºç™½è‰²
      Text('HarmonyOS éŸ³è§†é¢‘')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White) // æ”¹ä¸ºç™½è‰²
        .margin({ top: 20 })
        .align(Alignment.Top);

      // æ ¹æ®å½“å‰é€‰ä¸­çš„åº•éƒ¨æ ‡ç­¾æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹
      if (this.currentBottomTab === 0) {
        // é¦–é¡µå†…å®¹
        Scroll() {
          Row({ space: 20 }) {
            // è§†é¢‘æ’­æ”¾å¡ç‰‡
            Column() {
              Image($r('app.media.background1'))
                .width('100%')
                .height('60%')
                .objectFit(ImageFit.Cover)
                .borderRadius(16);
              Column() {
                Text('è§†é¢‘æ’­æ”¾')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 8 })
                  .fontColor(Color.White); // æ–‡å­—æ”¹ä¸ºç™½è‰²
                Text('ç•…äº«é«˜æ¸…è§†é¢‘ã€ç²¾å½©å†…å®¹')
                  .fontSize(12)
                  .opacity(0.8)
                  .margin({ bottom: 8 })
                  .fontColor('#AAAAAA'); // å‰¯æ ‡é¢˜æ”¹ä¸ºæµ…ç°è‰²
                Button('ç«‹å³ä½“éªŒ')
                  .width(100)
                  .height(30)
                  .fontSize(12)
                  .backgroundColor('#FF0050')
                  .fontColor(Color.White)
                  .margin({ top: 8 })
                  .onClick(() => {
                    router.pushUrl({ url: 'pages/TikTokStyle' });
                  });
              }
              .width('100%')
              .padding(10);
            }
            .width(this.cardWidth)
            .height(this.cardHeight)
            .backgroundColor('#1E1E1E') // å¡ç‰‡èƒŒæ™¯æ”¹ä¸ºæ·±ç°è‰²
            .borderRadius(16)
            .shadow({ radius: 8, color: '#000000', offsetX: 0, offsetY: 4 });

            // éŸ³é¢‘æ’­æ”¾å¡ç‰‡
            Column() {
              Column()
                .width('100%')
                .height('60%')
                .backgroundImage($r('app.media.gradient_bg'))
                .backgroundImageSize(ImageSize.Cover)
                .borderRadius(16);
              Column() {
                Text('éŸ³é¢‘æ’­æ”¾')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 8 })
                  .fontColor(Color.White);
                Text('æ²‰æµ¸å¼éŸ³ä¹ä½“éªŒ')
                  .fontSize(12)
                  .opacity(0.8)
                  .margin({ bottom: 8 })
                  .fontColor('#AAAAAA');
                Button('ç«‹å³ä½“éªŒ')
                  .width(100)
                  .height(30)
                  .fontSize(12)
                  .backgroundColor('#FF0050')
                  .fontColor(Color.White)
                  .margin({ top: 8 })
                  .onClick(() => {
                    router.pushUrl({ url: 'pages/AudioPlayer' });
                  });
              }
              .width('100%')
              .padding(10);
            }
            .width(this.cardWidth)
            .height(this.cardHeight)
            .backgroundColor('#1E1E1E')
            .borderRadius(16)
            .shadow({ radius: 8, color: '#000000', offsetX: 0, offsetY: 4 });

            // ä¸ªäººä¸­å¿ƒå¡ç‰‡
            Column() {
              Image($r('app.media.profile2'))
                .width('100%')
                .height('60%')
                .objectFit(ImageFit.Cover)
                .borderRadius(16);
              Column() {
                Text('ä¸ªäººä¸­å¿ƒ')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 8 })
                  .fontColor(Color.White);
                Text('ç®¡ç†éŸ³è§†é¢‘èµ„æº')
                  .fontSize(12)
                  .opacity(0.8)
                  .margin({ bottom: 8 })
                  .fontColor('#AAAAAA');
                Button('ç«‹å³ä½“éªŒ')
                  .width(100)
                  .height(30)
                  .fontSize(12)
                  .backgroundColor('#FF0050')
                  .fontColor(Color.White)
                  .margin({ top: 8 })
                  .onClick(() => {
                    router.pushUrl({ url: 'pages/ProfileCenter' });
                  });
              }
              .width('100%')
              .padding(10);
            }
            .width(this.cardWidth)
            .height(this.cardHeight)
            .backgroundColor('#1E1E1E')
            .borderRadius(16)
            .shadow({ radius: 8, color: '#000000', offsetX: 0, offsetY: 4 });
          }
          .justifyContent(FlexAlign.Center)
          .padding({ left: 20, right: 20 })
          .margin({ top: 100 });
        }
        .scrollable(ScrollDirection.Horizontal)
        .width('100%')
        .height('100%');
      } else if (this.currentBottomTab === 1) {
        // å‘çŽ°é¡µé¢å†…å®¹
        Column() {
          Text('å‘çŽ°é¡µé¢å†…å®¹')
            .fontSize(20)
            .margin({ top: 50 })
            .fontColor(Color.White);
        }
        .width('100%')
        .height('100%');
      } else if (this.currentBottomTab === 2) {
        // åˆ›å»ºé¡µé¢å†…å®¹
        Column() {
          Text('åˆ›å»ºé¡µé¢å†…å®¹')
            .fontSize(20)
            .margin({ top: 50 })
            .fontColor(Color.White);
        }
        .width('100%')
        .height('100%');
      } else if (this.currentBottomTab === 3) {
        // æ¶ˆæ¯é¡µé¢å†…å®¹
        Column() {
          Text('æ¶ˆæ¯é¡µé¢å†…å®¹')
            .fontSize(20)
            .margin({ top: 50 })
            .fontColor(Color.White);
        }
        .width('100%')
        .height('100%');
      } else if (this.currentBottomTab === 4) {
        // ä¸ªäººä¸­å¿ƒé¡µé¢å†…å®¹
        Column() {
          Text('ä¸ªäººä¸­å¿ƒé¡µé¢å†…å®¹')
            .fontSize(20)
            .margin({ top: 50 })
            .fontColor(Color.White);
        }
        .width('100%')
        .height('100%');
      }

      // åˆå§‹æµ®åŠ¨æç¤º (ä¿ç•™ï¼Œä½†ä¼šåœ¨æ–°æ¶ˆæ¯å¼¹çª—åŽéšè—)
      if (this.showInitialPrompt) {
        Column() {
          Text('ðŸ‘† ç‚¹å‡»å¡ç‰‡ä½“éªŒä¸åŒçš„åŠŸèƒ½')
            .fontSize(14)
            .fontColor(Color.White);
        }
        .width('auto')
        .height(40)
        .padding({ left: 24, right: 24 })
        .backgroundColor('rgba(255,255,255,0.2)') // æç¤ºæ¡†èƒŒæ™¯æ”¹ä¸ºåŠé€æ˜Žç™½è‰²
        .borderRadius(30)
        .position({ x: '50%', y: '80%' })
        .translate({ x: '-50%' })
        .onClick(() => {
          this.showInitialPrompt = false;
          hilog.info(DOMAIN_INDEX_PAGE, 'IndexPage', 'Initial prompt clicked and hidden.');
        });
      }

      // æ–°æ¶ˆæ¯å¼¹çª—
      if (this.showMessagePopup) {
        Row() {
          // å¤´åƒ (è¯·æ›¿æ¢ä¸ºä½ çš„å¤´åƒèµ„æº)
          Image($r('app.media.logo')) // ç¤ºä¾‹å¤´åƒï¼Œè¯·æ›¿æ¢
            .width(40)
            .height(40)
            .borderRadius(20) // åœ†å½¢å¤´åƒ
            .margin({ right: 10 });

          // æ¶ˆæ¯å†…å®¹
          Text('åŽŸç¥žï¼Œå¯åŠ¨ï¼')
            .fontSize(16)
            .fontColor(Color.Black); // æ¶ˆæ¯æ–‡æœ¬é¢œè‰²
        }
        .width('90%') // å¼¹çª—å®½åº¦
        .padding(15)
        .backgroundColor(Color.White) // å¼¹çª—èƒŒæ™¯é¢œè‰²
        .borderRadius(10) // åœ†è§’
        .position({ x: '5%', y: 50 }) // å®šä½åœ¨é¡µé¢é¡¶éƒ¨ï¼Œç•™å‡ºä¸€å®šè¾¹è·
        .shadow({ radius: 8, color: '#000000', offsetX: 0, offsetY: 4 }); // æ·»åŠ é˜´å½±æ•ˆæžœ
      }

      // è‡ªå®šä¹‰åº•éƒ¨å¯¼èˆªæ 
      Row() {
        // é¦–é¡µ
        Column() {
          Image($r('app.media.icon_home'))
            .width(24)
            .height(24)
            .objectFit(ImageFit.Contain)
            .margin({ bottom: 4 })
            .colorFilter({
              color: this.currentBottomTab === 0 ? '#FF0050' : '#FFFFFF'
            });
          Text('é¦–é¡µ')
            .fontSize(12)
            .fontColor(this.currentBottomTab === 0 ? '#FF0050' : '#FFFFFF');
        }
        .width('20%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.currentBottomTab = 0;
          // router.pushUrl({ url: 'pages/Index' }); // åœ¨å½“å‰é¡µä¸éœ€è¦å†æ¬¡è·³è½¬
        });
        // å‘çŽ°
        Column() {
          Image($r('app.media.icon_find'))
            .width(24)
            .height(24)
            .objectFit(ImageFit.Contain)
            .margin({ bottom: 4 })
            .colorFilter({
              color: this.currentBottomTab === 1 ? '#FF0050' : '#FFFFFF'
            });
          Text('å‘çŽ°')
            .fontSize(12)
            .fontColor(this.currentBottomTab === 1 ? '#FF0050' : '#FFFFFF');
        }
        .width('20%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.currentBottomTab = 1;
          router.pushUrl({ url: 'pages/Discover' });
        });
        // åˆ›å»º
        Column() {
          Image($r('app.media.icon_add'))
            .width(24)
            .height(24)
            .objectFit(ImageFit.Contain)
            .margin({ bottom: 4 })
            .colorFilter({
              color: this.currentBottomTab === 2 ? '#FF0050' : '#FFFFFF'
            });
          Text('åˆ›å»º')
            .fontSize(12)
            .fontColor(this.currentBottomTab === 2 ? '#FF0050' : '#FFFFFF');
        }
        .width('20%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.currentBottomTab = 2;
          router.pushUrl({ url: 'pages/Create' });
        });
        // æ¶ˆæ¯
        Column() {
          Image($r('app.media.icon_message'))
            .width(24)
            .height(24)
            .objectFit(ImageFit.Contain)
            .margin({ bottom: 4 })
            .colorFilter({
              color: this.currentBottomTab === 3 ? '#FF0050' : '#FFFFFF'
            });
          Text('æ¶ˆæ¯')
            .fontSize(12)
            .fontColor(this.currentBottomTab === 3 ? '#FF0050' : '#FFFFFF');
        }
        .width('20%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.currentBottomTab = 3;
          router.pushUrl({ url: 'pages/Message' });
        });
        // æˆ‘
        Column() {
          Image($r('app.media.icon_profile'))
            .width(24)
            .height(24)
            .objectFit(ImageFit.Contain)
            .margin({ bottom: 4 })
            .colorFilter({
              color: this.currentBottomTab === 4 ? '#FF0050' : '#FFFFFF'
            });
          Text('æˆ‘')
            .fontSize(12)
            .fontColor(this.currentBottomTab === 4 ? '#FF0050' : '#FFFFFF');
        }
        .width('20%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.currentBottomTab = 4;
          router.pushUrl({ url: 'pages/ProfileCenter' });
        });
      }
      .width('100%')
      .height(60)
      .backgroundColor('#1E1E1E')
      .position({ x: 0, y: '100%' })
      .translate({ y: -60 });
    }
    .width('100%')
    .height('100%')
    .onAreaChange(() => {
      this.calculateCardSize();
    });
  }
}
