import router from '@ohos.router';
import { display } from '@kit.ArkUI';

@Entry
@Component
struct Index {
  @State showInitialPrompt: boolean = true;
  @State showMessagePopup: boolean = false;
  @State cardWidth: number = 280;
  @State cardHeight: number = 400;
  @State currentTabIndex: number = 0;
  @State pageStack: string[] = []; // åˆå§‹åŒ–é¡µé¢æ ˆ

  // å®šä¹‰Tabé¡µé¢å¯¹åº”çš„è·¯ç”±
  private tabRoutes: string[] = [
    'pages/Index',
    'pages/Discover',
    'pages/Create',
    'pages/Message',
    'pages/ProfileCenter'
  ];

  aboutToAppear() {
    this.calculateCardSize();
    this.showInitialPrompt = false;
    this.showMessagePopup = true;

    setTimeout(() => {
      this.showMessagePopup = false;
    }, 3000);
  }

  calculateCardSize() {
    const displayWidth = display.getDefaultDisplaySync().width;
    const padding = 40;
    const gap = 20;
    let calculatedWidth = (displayWidth - padding - gap * 2) / 3;
    calculatedWidth = Math.max(200, Math.min(calculatedWidth, 320));
    this.cardWidth = calculatedWidth;
    this.cardHeight = calculatedWidth * 1.43;
  }

  // é¡µé¢è·³è½¬å¤„ç†
  navigateToPage(url: string) {
    if (this.pageStack.length > 0 && this.pageStack[this.pageStack.length - 1] === url) {
      // å¦‚æžœç›®æ ‡é¡µé¢å·²ç»åœ¨æ ˆé¡¶ï¼Œåˆ™åˆ·æ–°å½“å‰é¡µé¢
      router.back();
    } else {
      // æ·»åŠ æ–°é¡µé¢åˆ°æ ˆä¸­
      this.pageStack.push(url);
      // è·³è½¬åˆ°æ–°é¡µé¢
      router.pushUrl({ url: url }, router.RouterMode.Single);
    }
  }

  // é¡µé¢å›žé€€å¤„ç†
  navigateBack() {
    if (this.pageStack.length > 1) {
      // ç§»é™¤å½“å‰é¡µé¢
      this.pageStack.pop();

      // èŽ·å–æ–°çš„æ ˆé¡¶é¡µé¢
      const newTopPage = this.pageStack[this.pageStack.length - 1];

      // æ›´æ–°å½“å‰Tabç´¢å¼•
      this.currentTabIndex = this.tabRoutes.indexOf(newTopPage);

      // è·³è½¬åˆ°æ–°çš„æ ˆé¡¶é¡µé¢
      router.pushUrl({ url: newTopPage }, router.RouterMode.Single);
    } else if (this.pageStack.length === 1) {
      // å¦‚æžœæ ˆä¸­åªå‰©ä¸€ä¸ªé¡µé¢ï¼Œåˆ™ç›´æŽ¥å›žé€€åˆ°è¯¥é¡µé¢
      router.replaceUrl({ url: 'pages/Index' }, router.RouterMode.Single);

      // æ›´æ–°å½“å‰Tabç´¢å¼•ä¸ºé¦–é¡µ
      this.currentTabIndex = 0;
    }
  }

  // Tabåˆ‡æ¢å¤„ç†
  onTabChange(index: number) {
    if (this.currentTabIndex !== index) {
      this.currentTabIndex = 0;
      this.navigateToPage(this.tabRoutes[index]);
    }
  }

  build() {
    Column() {
      // ä¸»å†…å®¹åŒºåŸŸ - ä½¿ç”¨Tabsç»„ä»¶
      Tabs({ barPosition: BarPosition.End }) {
        // é¦–é¡µTab
        TabContent() {
          this.buildHomeContent();
        }.tabBar(this.buildTabBarItem(0, $r('app.media.icon_home'), 'é¦–é¡µ'))

        // å‘çŽ°Tab
        TabContent() {
        }.tabBar(this.buildTabBarItem(1, $r('app.media.icon_discover'), 'å‘çŽ°'))

        // åˆ›å»ºTab
        TabContent() {
        }.tabBar(this.buildTabBarItem(2, $r('app.media.icon_add'), 'åˆ›å»º'))

        // æ¶ˆæ¯Tab
        TabContent() {
        }.tabBar(this.buildTabBarItem(3, $r('app.media.icon_message'), 'æ¶ˆæ¯'))

        // ä¸ªäººä¸­å¿ƒTab
        TabContent() {
        }.tabBar(this.buildTabBarItem(4, $r('app.media.icon_profile'), 'æˆ‘'))
      }
      .barWidth('100%')
      .barHeight(60)
      .backgroundColor('#1E1E1E')

      // åˆå§‹æµ®åŠ¨æç¤º
      if (this.showInitialPrompt) {
        Column() {
          Text('ðŸ‘† ç‚¹å‡»å¡ç‰‡ä½“éªŒä¸åŒçš„åŠŸèƒ½')
            .fontSize(14)
            .fontColor(Color.White);
        }
        .width('auto')
        .height(40)
        .padding({ left: 24, right: 24 })
        .backgroundColor('rgba(255,255,255,0.2)')
        .borderRadius(30)
        .position({ x: '50%', y: '80%' })
        .translate({ x: '-50%' })
        .onClick(() => {
          this.showInitialPrompt = false;
        });
      }

      // æ–°æ¶ˆæ¯å¼¹çª—
      if (this.showMessagePopup) {
        Row() {
          Image($r('app.media.logo'))
            .width(40)
            .height(40)
            .borderRadius(20)
            .margin({ right: 10 });

          Text('åŽŸç¥žï¼Œå¯åŠ¨ï¼')
            .fontSize(16)
            .fontColor(Color.Black);
        }
        .width('90%')
        .padding(15)
        .backgroundColor(Color.White)
        .borderRadius(10)
        .position({ x: '5%', y: 50 })
        .shadow({ radius: 8, color: '#000000', offsetX: 0, offsetY: 4 });
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#121212')
    .onAreaChange(() => {
      this.calculateCardSize();
    });
  }

  // æž„å»ºé¦–é¡µå†…å®¹
  @Builder
  buildHomeContent() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜
      Text('HarmonyOS éŸ³è§†é¢‘')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
        .margin({ top: 20 });

      // ä¸»å†…å®¹åŒºåŸŸ
      Scroll() {
        Row({ space: 10 }) {
          // è§†é¢‘æ’­æ”¾å¡ç‰‡
          Column() {
            Image($r('app.media.background1'))
              .width('100%')
              .height('60%')
              .objectFit(ImageFit.Cover)
              .borderRadius(16);
            Column() {
              Text('è§†é¢‘æ’­æ”¾')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 8 })
                .fontColor(Color.White);
              Text('ç•…äº«é«˜æ¸…è§†é¢‘ã€ç²¾å½©å†…å®¹')
                .fontSize(13)
                .opacity(0.8)
                .margin({ bottom: 8 })
                .fontColor('#AAAAAA');
              Button('ç«‹å³ä½“éªŒ')
                .width(100)
                .height(40)
                .fontSize(14)
                .backgroundColor('#FF0050')
                .fontColor(Color.White)
                .margin({ top: 8 })
                .onClick(() => {
                  this.navigateToPage('pages/TikTokStyle');
                });
            }
            .width('100%')
            .padding(10);
          }
          .width(this.cardWidth)
          .height(this.cardHeight)
          .backgroundColor('#1E1E1E')
          .borderRadius(16)
          .shadow({ radius: 8, color: '#000000', offsetX: 0, offsetY: 4 });

          // éŸ³é¢‘æ’­æ”¾å¡ç‰‡
          Column() {
            Column()
              .width('100%')
              .height('60%')
              .backgroundImage($r('app.media.gradient_bg'))
              .backgroundImageSize(ImageSize.Cover)
              .borderRadius(16);
            Column() {
              Text('éŸ³é¢‘æ’­æ”¾')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 8 })
                .fontColor(Color.White);
              Text('æ²‰æµ¸å¼éŸ³ä¹ä½“éªŒ')
                .fontSize(14)
                .opacity(0.8)
                .margin({ bottom: 8 })
                .fontColor('#AAAAAA');
              Button('ç«‹å³ä½“éªŒ')
                .width(100)
                .height(30)
                .fontSize(14)
                .backgroundColor('#FF0050')
                .fontColor(Color.White)
                .margin({ top: 8 })
                .onClick(() => {
                  this.navigateToPage('pages/AudioPlayer');
                });
            }
            .width('100%')
            .padding(10);
          }
          .width(this.cardWidth)
          .height(this.cardHeight)
          .backgroundColor('#1E1E1E')
          .borderRadius(16)
          .shadow({ radius: 8, color: '#000000', offsetX: 0, offsetY: 4 });

          // ä¸ªäººä¸­å¿ƒå¡ç‰‡
          Column() {
            Image($r('app.media.profile2'))
              .width('100%')
              .height('60%')
              .objectFit(ImageFit.Cover)
              .borderRadius(16);
            Column() {
              Text('ä¸ªäººä¸­å¿ƒ')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 8 })
                .fontColor(Color.White);
              Text('ç®¡ç†éŸ³è§†é¢‘èµ„æº')
                .fontSize(14)
                .opacity(0.8)
                .margin({ bottom: 8 })
                .fontColor('#AAAAAA');
              Button('ç«‹å³ä½“éªŒ')
                .width(100)
                .height(30)
                .fontSize(14)
                .backgroundColor('#FF0050')
                .fontColor(Color.White)
                .margin({ top: 8 })
                .onClick(() => {
                  this.navigateToPage('pages/ProfileCenter');
                });
            }
            .width('100%')
            .padding(10);
          }
          .width(this.cardWidth)
          .height(this.cardHeight)
          .backgroundColor('#1E1E1E')
          .borderRadius(16)
          .shadow({ radius: 8, color: '#000000', offsetX: 0, offsetY: 4 });
        }
        .justifyContent(FlexAlign.Center)
        .padding({ left: 20, right: 20 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .width('100%')
      .height('100%');
    }
    .width('100%')
    .height('100%');
  }

  // æž„å»ºTabBaré¡¹
  @Builder
  buildTabBarItem(index: number, icon: Resource, text: string) {
    Column() {
      Image(icon)
        .width(24)
        .height(24)
        .objectFit(ImageFit.Contain)
        .margin({ bottom: 4 })
        .colorFilter({
          color: this.currentTabIndex === index ? '#FF0050' : '#FFFFFF'
        });
      Text(text)
        .fontSize(12)
        .fontColor(this.currentTabIndex === index ? '#FF0050' : '#FFFFFF');
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.onTabChange(index);
    });
  }
}
