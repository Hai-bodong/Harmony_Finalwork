import router from '@ohos.router';
import { display } from '@kit.ArkUI';

@Entry
@Component
struct Index {
  @State showPrompt: boolean = true;
  @State cardWidth: number = 280;
  @State cardHeight: number = 400;
  @State currentTabIndex: number = 0;
  @State currentBottomTab: number = 0 // é»˜è®¤é€‰ä¸­"é¦–é¡µ"çš„æ ‡ç­¾é¡µ

  aboutToAppear() {
    this.calculateCardSize();
    setTimeout(() => {
      this.showPrompt = false;
    }, 1000);
  }

  calculateCardSize() {
    // è·å–å±å¹•å®½åº¦å¹¶è®¡ç®—å¡ç‰‡å°ºå¯¸
    const displayWidth = display.getDefaultDisplaySync().width;
    const padding = 40; // ä¸¤ä¾§æ€»è¾¹è·
    const gap = 20; // å¡ç‰‡é—´è·

    // è®¡ç®—å•ä¸ªå¡ç‰‡å®½åº¦ï¼ˆé™åˆ¶åœ¨200-320vpä¹‹é—´ï¼‰
    let calculatedWidth = (displayWidth - padding - gap * 2) / 3;
    calculatedWidth = Math.max(200, Math.min(calculatedWidth, 320));

    // é«˜åº¦æŒ‰4:5.7æ¯”ä¾‹è®¡ç®—
    this.cardWidth = calculatedWidth;
    this.cardHeight = calculatedWidth * 1.43;
  }

  build() {
    Tabs({ barPosition: BarPosition.End }) {
      // é¦–é¡µTab
      TabContent() {
        Stack({ alignContent: Alignment.Top }) {
          // èƒŒæ™¯
          Column() {
            Blank();
          }
          .width('100%')
          .height('100%')
          .backgroundColor(Color.White);

          // Logo
          Text('HarmonyOS éŸ³è§†é¢‘')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.Black)
            .margin({ top: 20 })
            .align(Alignment.Top);

          // å¡ç‰‡å®¹å™¨
          Scroll() {
            Row({ space: 20 }) {
              // è§†é¢‘æ’­æ”¾å¡ç‰‡
              Column() {
                Image($r('app.media.background1'))
                  .width('100%')
                  .height('60%')
                  .objectFit(ImageFit.Cover)
                  .borderRadius(16);

                Column() {
                  Text('è§†é¢‘æ’­æ”¾')
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .margin({ bottom: 8 });

                  Text('ç•…äº«é«˜æ¸…è§†é¢‘ã€ç²¾å½©å†…å®¹')
                    .fontSize(12)
                    .opacity(0.8)
                    .margin({ bottom: 8 });

                  Button('ç«‹å³ä½“éªŒ')
                    .width(100)
                    .height(30)
                    .fontSize(12)
                    .backgroundColor('#FF0050')
                    .fontColor(Color.White)
                    .margin({ top: 8 })
                    .onClick(() => {
                      router.pushUrl({ url: 'pages/TikTokStyle' });
                    });
                }
                .width('100%')
                .padding(10);
              }
              .width(this.cardWidth)
              .height(this.cardHeight)
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(16)
              .shadow({ radius: 8, color: '#00000033', offsetX: 0, offsetY: 4 });

              // éŸ³é¢‘æ’­æ”¾å¡ç‰‡
              Column() {
                Column()
                  .width('100%')
                  .height('60%')
                  .backgroundImage($r('app.media.gradient_bg'))
                  .backgroundImageSize(ImageSize.Cover)
                  .borderRadius(16);

                Column() {
                  Text('éŸ³é¢‘æ’­æ”¾')
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .margin({ bottom: 8 });

                  Text('æ²‰æµ¸å¼éŸ³ä¹ä½“éªŒ')
                    .fontSize(12)
                    .opacity(0.8)
                    .margin({ bottom: 8 });

                  Button('ç«‹å³ä½“éªŒ')
                    .width(100)
                    .height(30)
                    .fontSize(12)
                    .backgroundColor('#FF0050')
                    .fontColor(Color.White)
                    .margin({ top: 8 })
                    .onClick(() => {
                      router.pushUrl({ url: 'pages/AudioPlayer' });
                    });
                }
                .width('100%')
                .padding(10);
              }
              .width(this.cardWidth)
              .height(this.cardHeight)
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(16)
              .shadow({ radius: 8, color: '#00000033', offsetX: 0, offsetY: 4 });

              // ä¸ªäººä¸­å¿ƒå¡ç‰‡
              Column() {
                Image($r('app.media.profile2'))
                  .width('100%')
                  .height('60%')
                  .objectFit(ImageFit.Cover)
                  .borderRadius(16);

                Column() {
                  Text('ä¸ªäººä¸­å¿ƒ')
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .margin({ bottom: 8 });

                  Text('ç®¡ç†éŸ³è§†é¢‘èµ„æº')
                    .fontSize(12)
                    .opacity(0.8)
                    .margin({ bottom: 8 });

                  Button('ç«‹å³ä½“éªŒ')
                    .width(100)
                    .height(30)
                    .fontSize(12)
                    .backgroundColor('#FF0050')
                    .fontColor(Color.White)
                    .margin({ top: 8 })
                    .onClick(() => {
                      router.pushUrl({ url: 'pages/ProfileCenter' });
                    });
                }
                .width('100%')
                .padding(10);
              }
              .width(this.cardWidth)
              .height(this.cardHeight)
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(16)
              .shadow({ radius: 8, color: '#00000033', offsetX: 0, offsetY: 4 });
            }
            .justifyContent(FlexAlign.Center)
            .padding({ left: 20, right: 20 })
            .margin({ top: 100 });
          }
          .scrollable(ScrollDirection.Horizontal)
          .width('100%')
          .height('100%');

          // æµ®åŠ¨æç¤º
          if (this.showPrompt) {
            Column() {
              Text('ğŸ‘† ç‚¹å‡»å¡ç‰‡ä½“éªŒä¸åŒçš„åŠŸèƒ½')
                .fontSize(14)
                .fontColor(Color.White);
            }
            .width('auto')
            .height(40)
            .padding({ left: 24, right: 24 })
            .backgroundColor('rgba(0,0,0,0.7)')
            .borderRadius(30)
            .position({ x: '50%', y: '80%' })
            .translate({ x: '-50%' })
            .onClick(() => {
              this.showPrompt = false;
            });
          }
        }
        .width('100%')
        .height('100%')
        .onAreaChange(() => {
          this.calculateCardSize();
        });
      }
      .tabBar(this.TabBuilder('é¦–é¡µ', 0, $r('app.media.icon_home')));

      // å‘ç°Tab
      TabContent() {
        Column() {
          Text('å‘ç°é¡µé¢å†…å®¹')
            .fontSize(20)
            .margin({ top: 50 });
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#121212');
      }
      .tabBar(this.TabBuilder('å‘ç°', 1, $r('app.media.icon_search')));

      // åˆ›å»ºTab
      TabContent() {
        Column() {
          Text('åˆ›å»ºé¡µé¢å†…å®¹')
            .fontSize(20)
            .margin({ top: 50 });
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#121212');
      }
      .tabBar(this.TabBuilder('åˆ›å»º', 2, $r('app.media.icon_add')));

      // æ¶ˆæ¯Tab
      TabContent() {
        Column() {
          Text('æ¶ˆæ¯é¡µé¢å†…å®¹')
            .fontSize(20)
            .margin({ top: 50 });
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#121212');
      }
      .tabBar(this.TabBuilder('æ¶ˆæ¯', 3, $r('app.media.icon_message')));

      // æˆ‘çš„Tab
      TabContent() {
        Column() {
          Text('ä¸ªäººä¸­å¿ƒé¡µé¢å†…å®¹')
            .fontSize(20)
            .margin({ top: 50 });
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#121212');
      }
      .tabBar(this.TabBuilder('æˆ‘', 4, $r('app.media.icon_profile')));
    }
    .barMode(BarMode.Fixed)
    .barWidth('100%')
    .barHeight(60)
    .onChange((index: number) => {
      this.currentBottomTab = index
      // è¿™é‡Œå¯ä»¥æ·»åŠ é¡µé¢è·³è½¬é€»è¾‘
      if (index === 0) {
        router.pushUrl({ url: 'pages/Index' })
      } else if (index === 1) {
        router.pushUrl({ url: 'pages/Discover' })
      } else if (index === 2) {
        router.pushUrl({ url: 'pages/Create' })
      } else if (index === 3) {
        router.pushUrl({ url: 'pages/Message' })
      } else if (index === 4) {
        router.pushUrl({url: 'pages/ProfileCenter'})
      }
    })
  }

  @Builder TabBuilder(title: string, index: number, icon: Resource) {
    Column() {
      Image(icon)
        .width(24)
        .height(24)
        .objectFit(ImageFit.Contain)
        .margin({ bottom: 4 });

      Text(title)
        .fontSize(12);
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .opacity(this.currentTabIndex === index ? 1 : 0.6);
  }
}